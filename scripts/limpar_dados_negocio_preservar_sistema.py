#!/usr/bin/env python3
"""
LIMPEZA DE DADOS DE NEG√ìCIO - PRESERVANDO SISTEMA
Remove dados cadastrais (empresas, clientes, etc.) mas preserva:
- 1 usu√°rio ROOT/admin
- Todos os menus
- Todas as roles
- Estrutura do sistema
"""

import asyncio
import sys
from pathlib import Path

# Adicionar o diret√≥rio raiz ao path
sys.path.append(str(Path(__file__).parent.parent))

from sqlalchemy import text

from app.infrastructure.database import engine


async def cleanup_business_data_preserve_system():
    """Limpar dados de neg√≥cio preservando estrutura do sistema"""

    print("üßπ LIMPEZA DE DADOS DE NEG√ìCIO - PRESERVANDO SISTEMA")
    print("=" * 60)

    async with engine.begin() as conn:

        # Reset admin context
        await conn.execute(text("SELECT master.set_current_company_id(0)"))

        print("\n1Ô∏è‚É£ AN√ÅLISE DO SISTEMA ATUAL:")

        # Verificar usu√°rios (identificar o admin/root)
        result = await conn.execute(
            text(
                """
            SELECT id, email_address,
                   CASE WHEN email_address ILIKE '%admin%'
                        OR email_address ILIKE '%root%'
                        OR email_address = 'admin@example.com'
                   THEN 'ADMIN' ELSE 'NORMAL' END as user_type
            FROM master.users
            ORDER BY id
        """
            )
        )
        users = result.fetchall()

        admin_users = [u for u in users if u.user_type == "ADMIN"]
        normal_users = [u for u in users if u.user_type == "NORMAL"]

        print(f"   üë§ Usu√°rios ADMIN/ROOT: {len(admin_users)}")
        for admin in admin_users:
            print(f"      - ID {admin.id}: {admin.email_address} ‚úÖ PRESERVAR")

        print(f"   üë• Usu√°rios NORMAIS: {len(normal_users)}")
        for user in normal_users:
            print(f"      - ID {user.id}: {user.email_address} üóëÔ∏è REMOVER")

        # Contar elementos que ser√£o preservados
        result = await conn.execute(text("SELECT COUNT(*) FROM master.menus"))
        menus_count = result.scalar()

        result = await conn.execute(text("SELECT COUNT(*) FROM master.roles"))
        roles_count = result.scalar()

        print(f"\n   üìã Menus: {menus_count} ‚úÖ PRESERVAR TODOS")
        print(f"   üîê Roles: {roles_count} ‚úÖ PRESERVAR TODAS")

        # Contar dados de neg√≥cio que ser√£o removidos
        business_tables = {
            "companies": "Empresas",
            "establishments": "Estabelecimentos",
            "clients": "Clientes",
            "phones": "Telefones",
            "emails": "E-mails",
            "addresses": "Endere√ßos",
        }

        business_counts = {}
        print(f"\n   üóëÔ∏è DADOS DE NEG√ìCIO A REMOVER:")
        for table, desc in business_tables.items():
            try:
                result = await conn.execute(
                    text(f"SELECT COUNT(*) FROM master.{table}")
                )
                count = result.scalar()
                business_counts[table] = count
                print(f"      - {desc}: {count}")
            except Exception as e:
                business_counts[table] = 0
                print(f"      - {desc}: 0 (erro: {e})")

        # Verificar people que ser√£o afetadas
        result = await conn.execute(
            text(
                """
            SELECT COUNT(*) FROM master.people p
            WHERE p.id IN (SELECT person_id FROM master.companies)
        """
            )
        )
        company_people = result.scalar()

        result = await conn.execute(
            text(
                """
            SELECT COUNT(*) FROM master.people p
            WHERE p.id NOT IN (
                SELECT person_id FROM master.users WHERE person_id IS NOT NULL
                UNION
                SELECT person_id FROM master.companies WHERE person_id IS NOT NULL
            )
        """
            )
        )
        orphan_people = result.scalar()

        print(f"\n   üë• PESSOAS:")
        print(f"      - Ligadas a empresas: {company_people} üóëÔ∏è REMOVER")
        print(f"      - √ìrf√£s: {orphan_people} üóëÔ∏è REMOVER")
        print(f"      - Ligadas a usu√°rios admin: ‚úÖ PRESERVAR")

        total_to_remove = (
            sum(business_counts.values())
            + company_people
            + orphan_people
            + len(normal_users)
        )

        if len(admin_users) == 0:
            print(f"\n‚ùå ERRO: Nenhum usu√°rio ADMIN encontrado!")
            print(f"   üîß Sem usu√°rio admin, o sistema ficar√° inacess√≠vel")
            return

        print(f"\nüìä RESUMO:")
        print(
            f"   ‚úÖ PRESERVAR: {len(admin_users)} admin(s), {menus_count} menus, {roles_count} roles"
        )
        print(f"   üóëÔ∏è REMOVER: {total_to_remove} registros de dados de neg√≥cio")

        # Executar limpeza
        print(f"\n2Ô∏è‚É£ EXECUTANDO LIMPEZA SELETIVA:")

        removed_counts = {}

        # PASSO 1: Remover depend√™ncias de usu√°rios normais
        print(f"\n   üîó Removendo depend√™ncias de usu√°rios normais...")

        if normal_users:
            normal_user_ids = [str(u.id) for u in normal_users]
            user_ids_str = ",".join(normal_user_ids)

            # Remover user_roles de usu√°rios normais
            result = await conn.execute(
                text(
                    f"""
                DELETE FROM master.user_roles
                WHERE user_id IN ({user_ids_str})
            """
                )
            )
            removed_counts["user_roles"] = result.rowcount
            print(f"      - user_roles (normais): {result.rowcount}")

            # Remover user_sessions de usu√°rios normais
            result = await conn.execute(
                text(
                    f"""
                DELETE FROM master.user_sessions
                WHERE user_id IN ({user_ids_str})
            """
                )
            )
            removed_counts["user_sessions"] = result.rowcount
            print(f"      - user_sessions (normais): {result.rowcount}")

            # Remover user_establishments de usu√°rios normais
            result = await conn.execute(
                text(
                    f"""
                DELETE FROM master.user_establishments
                WHERE user_id IN ({user_ids_str})
            """
                )
            )
            removed_counts["user_establishments"] = result.rowcount
            print(f"      - user_establishments (normais): {result.rowcount}")

            # Remover role_permissions concedidas por usu√°rios normais
            result = await conn.execute(
                text(
                    f"""
                DELETE FROM master.role_permissions
                WHERE granted_by_user_id IN ({user_ids_str})
            """
                )
            )
            removed_counts["role_permissions"] = result.rowcount
            print(f"      - role_permissions (normais): {result.rowcount}")
        else:
            print(f"      - Nenhum usu√°rio normal para limpar depend√™ncias")

        # PASSO 2: Remover dados de neg√≥cio
        print(f"\n   üìã Removendo dados de neg√≥cio...")

        # Remover establishments
        result = await conn.execute(text("DELETE FROM master.establishments"))
        removed_counts["establishments"] = result.rowcount
        print(f"      - establishments: {result.rowcount}")

        # Remover clients
        result = await conn.execute(text("DELETE FROM master.clients"))
        removed_counts["clients"] = result.rowcount
        print(f"      - clients: {result.rowcount}")

        # Remover contatos
        result = await conn.execute(text("DELETE FROM master.phones"))
        removed_counts["phones"] = result.rowcount
        print(f"      - phones: {result.rowcount}")

        result = await conn.execute(text("DELETE FROM master.emails"))
        removed_counts["emails"] = result.rowcount
        print(f"      - emails: {result.rowcount}")

        result = await conn.execute(text("DELETE FROM master.addresses"))
        removed_counts["addresses"] = result.rowcount
        print(f"      - addresses: {result.rowcount}")

        # PASSO 3: Remover usu√°rios normais ANTES de remover companies
        if normal_users:
            print(f"\n   üë• Removendo usu√°rios normais...")
            result = await conn.execute(
                text(
                    f"""
                DELETE FROM master.users
                WHERE id IN ({user_ids_str})
            """
                )
            )
            removed_counts["users_normal"] = result.rowcount
            print(f"      - usu√°rios normais: {result.rowcount}")

        # PASSO 4: Remover people das empresas (preservando as de admin)
        print(f"\n   üßπ Removendo people de empresas (preservando admin)...")
        result = await conn.execute(
            text(
                """
            DELETE FROM master.people
            WHERE id IN (SELECT person_id FROM master.companies)
            AND id NOT IN (
                SELECT person_id FROM master.users WHERE person_id IS NOT NULL
            )
        """
            )
        )
        removed_counts["people_companies"] = result.rowcount
        print(f"      - people de empresas: {result.rowcount}")

        # PASSO 5: Agora remover companies (n√£o tem mais people referenciando)
        result = await conn.execute(text("DELETE FROM master.companies"))
        removed_counts["companies"] = result.rowcount
        print(f"      - companies: {result.rowcount}")

        # PASSO 6: Limpar people √≥rf√£s restantes
        print(f"\n   üßπ Limpeza final de people √≥rf√£s...")
        result = await conn.execute(
            text(
                """
            DELETE FROM master.people
            WHERE id NOT IN (
                SELECT person_id FROM master.users WHERE person_id IS NOT NULL
            )
        """
            )
        )
        removed_counts["people_final"] = result.rowcount
        print(f"      - people √≥rf√£s finais: {result.rowcount}")

        print(f"\n3Ô∏è‚É£ VERIFICA√á√ÉO P√ìS-LIMPEZA:")

        # Verificar preserva√ß√£o do sistema
        result = await conn.execute(
            text(
                """
            SELECT id, email_address FROM master.users
            ORDER BY id
        """
            )
        )
        remaining_users = result.fetchall()

        result = await conn.execute(text("SELECT COUNT(*) FROM master.menus"))
        final_menus = result.scalar()

        result = await conn.execute(text("SELECT COUNT(*) FROM master.roles"))
        final_roles = result.scalar()

        print(f"\n   ‚úÖ SISTEMA PRESERVADO:")
        print(f"      - Usu√°rios admin: {len(remaining_users)}")
        for user in remaining_users:
            print(f"        * ID {user.id}: {user.email_address}")
        print(f"      - Menus: {final_menus}")
        print(f"      - Roles: {final_roles}")

        # Verificar limpeza dos dados de neg√≥cio
        print(f"\n   üóëÔ∏è DADOS DE NEG√ìCIO LIMPOS:")
        final_business = {}
        for table, desc in business_tables.items():
            result = await conn.execute(text(f"SELECT COUNT(*) FROM master.{table}"))
            count = result.scalar()
            final_business[table] = count
            status = "‚úÖ" if count == 0 else "‚ö†Ô∏è"
            print(f"      {status} {desc}: {count}")

        result = await conn.execute(text("SELECT COUNT(*) FROM master.people"))
        final_people = result.scalar()
        print(f"      üìã People restantes: {final_people}")

        print(f"\n4Ô∏è‚É£ RESUMO FINAL:")
        total_removed = sum(removed_counts.values())
        print(f"   üìä Total removido: {total_removed} registros")

        print(f"\n   üìã DETALHES DA REMO√á√ÉO:")
        for key, count in removed_counts.items():
            if count > 0:
                print(f"      - {key}: {count}")

        # Status final
        business_clean = all(count == 0 for count in final_business.values())
        system_intact = len(remaining_users) > 0 and final_menus > 0 and final_roles > 0

        if business_clean and system_intact:
            print(f"\n   üéâ LIMPEZA SELETIVA CONCLU√çDA COM SUCESSO!")
            print(f"   ‚úÖ Sistema preservado (admin, menus, roles)")
            print(f"   ‚úÖ Dados de neg√≥cio limpos")
            print(f"   üöÄ PRONTO PARA NOVOS CADASTROS COM ESTRUTURA MULTI-TENANT!")

            if len(remaining_users) == 1:
                admin_user = remaining_users[0]
                print(f"\n   üîë LOGIN DO SISTEMA:")
                print(f"      Email: {admin_user.email_address}")
                print(f"      Senha: (a senha que voc√™ definiu)")
        else:
            print(f"\n   ‚ö†Ô∏è  Limpeza com ressalvas:")
            if not system_intact:
                print(f"      üîß Sistema comprometido - verificar admin/menus/roles")
            if not business_clean:
                remaining_business = sum(final_business.values())
                print(f"      üîß Dados de neg√≥cio restantes: {remaining_business}")


async def main():
    """Fun√ß√£o principal"""
    try:
        await cleanup_business_data_preserve_system()
    except Exception as e:
        print(f"‚ùå Erro durante limpeza: {e}")
        import traceback

        traceback.print_exc()


if __name__ == "__main__":
    asyncio.run(main())
